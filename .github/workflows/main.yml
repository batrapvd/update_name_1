name: Continuous Display Name Update

on:
  # Manual trigger only for continuous mode
  workflow_dispatch:
    inputs:
      duration_minutes:
        description: 'How many minutes to run continuously'
        required: true
        default: '380'
      batch_size:
        description: 'Batch size (rows per batch)'
        required: false
        default: '100'
      workers:
        description: 'Number of worker threads'
        required: false
        default: '2'

jobs:
  continuous-update:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # Max 6 hours
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run continuous update
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          SPEEDLIMIT_DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          DURATION_MINUTES="${{ github.event.inputs.duration_minutes }}"
          BATCH_SIZE="${{ github.event.inputs.batch_size }}"
          WORKERS="${{ github.event.inputs.workers }}"

          # Calculate hours and minutes for display
          HOURS=$((DURATION_MINUTES / 60))
          MINS=$((DURATION_MINUTES % 60))

          echo "Starting continuous display name updater..."
          echo "Configuration:"
          echo "  - Duration: ${HOURS}h ${MINS}m (${DURATION_MINUTES} minutes)"
          echo "  - Batch size: $BATCH_SIZE"
          echo "  - Workers: $WORKERS"

          # Run in background with timeout (using minutes)
          # Using 1.2s sleep to strictly respect Nominatim's 1 req/sec limit
          timeout ${DURATION_MINUTES}m python3 update_display_name.py \
            --batch-size "$BATCH_SIZE" \
            --workers "$WORKERS" \
            --sleep 1.2 \
            --loop \
            --idle-sleep 60 \
            --timeout 15.0 \
            --retries 3 \
            --log-file logs/continuous_update.log \
            || true

          echo "Continuous update finished after timeout or completion"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: continuous-update-logs-${{ github.run_number }}
          path: logs/
          retention-days: 7

      - name: Show statistics
        if: always()
        run: |
          echo "ðŸ“Š Update Statistics:"
          if [ -f logs/continuous_update.log ]; then
            echo ""
            echo "Total rows updated:"
            grep -c "Successfully updated" logs/continuous_update.log || echo "0"
            echo ""
            echo "Last 30 lines of log:"
            tail -n 30 logs/continuous_update.log
          fi

      - name: Trigger next workflow run
        if: success()
        run: |
          echo "ðŸ”„ Triggering new workflow run..."
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${{ github.repository }}/actions/workflows/main.yml/dispatches \
            -d '{
              "ref": "${{ github.ref_name }}",
              "inputs": {
                "duration_minutes": "${{ github.event.inputs.duration_minutes }}",
                "batch_size": "${{ github.event.inputs.batch_size }}",
                "workers": "${{ github.event.inputs.workers }}"
              }
            }'
          echo "âœ… New workflow run triggered successfully (will start in 6h 20m)"
